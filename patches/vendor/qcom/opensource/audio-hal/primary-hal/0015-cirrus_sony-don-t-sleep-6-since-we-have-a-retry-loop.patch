From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Frajo Haider <f_haider@gmx.at>
Date: Wed, 10 Mar 2021 19:18:21 +0000
Subject: [PATCH] cirrus_sony: don't sleep(6) since we have a retry loop
 already.

Instead extend the retry loop to include the 6 seconds in which
previously nothing was done.
---
 hal/audio_extn/cirrus_sony.c | 13 ++-----------
 1 file changed, 2 insertions(+), 11 deletions(-)

diff --git a/hal/audio_extn/cirrus_sony.c b/hal/audio_extn/cirrus_sony.c
index 95422b3e5ba970fe51706d9ad7a5286d749576c4..6d9879ae751fcde57cd05bb54f62e6cf0f3dea71 100644
--- a/hal/audio_extn/cirrus_sony.c
+++ b/hal/audio_extn/cirrus_sony.c
@@ -1248,7 +1248,7 @@ exit:
 
 static int cirrus_do_fw_mono_download(int do_reset) {
     bool cal_valid = false, status_ok = false, checksum_ok = false;
-    int i, max_retries = 24, ret = 0;
+    int i, max_retries = 32, ret = 0;
 
     for (i = 0; i < max_retries; i++) {
         ret = cirrus_exec_fw_download("Protection", 0, do_reset);
@@ -1303,7 +1303,7 @@ static int cirrus_do_fw_stereo_download(int do_reset) {
     char *ctl_name;
     int ctl_sz = CIRRUS_CTL_NAME_BUF;
     bool cal_valid = false, status_ok = false, checksum_ok = false;
-    int i, max_retries = 24, ret = 0;
+    int i, max_retries = 32, ret = 0;
 
     ALOGI("%s: Sending speaker protection stereo firmware", __func__);
 
@@ -1471,15 +1471,6 @@ static void *cirrus_do_calibration() {
         ret = 0;
     }
 
-    /*
-     * There is no way to know when the DSP will be really ready. Usually,
-     * it takes around 4 seconds, but let's wait a bit more... In any case
-     * the calibration process happens only *once* in an entire userdata
-     * life, which means that only the first boot ever will be slow, in
-     * favor of a good speaker calibration.
-     */
-    sleep(6);
-
 skip_calibration:
     if (handle.is_stereo)
         ret = cirrus_do_fw_stereo_download(0);
